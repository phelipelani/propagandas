<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Totem de Propagandas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- Reset & Base Styles --- */
      :root {
        --info-bar-bg: #1a202c;
        --info-bar-text: #ffffff;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        font-family: "Poppins", sans-serif;
      }

      /* --- Layout Base --- */
      body {
        display: flex;
        flex-direction: column;
        background-color: #000;
      }

      /* --- Container de Mídia (CORRIGIDO) --- */
      #media-container {
        flex-grow: 1; /* Faz o container ocupar todo o espaço vertical disponível */
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
      }

      /* Estilo para a mídia de FUNDO (desfocada) */
      .media-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover; /* Cobre todo o espaço */
        filter: blur(30px); /* Desfoque intenso */
        transform: scale(1.1); /* Zoom para esconder bordas do desfoque */
        opacity: 0.6; /* Leve transparência */
        z-index: 1;
      }

      /* Estilo para a mídia PRINCIPAL (à frente) */
      .media-foreground {
        position: relative;
        z-index: 2;
        max-width: 100%;
        max-height: 100%;
        object-fit: contain; /* Garante que a mídia apareça inteira, sem cortes */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Sombra para destacar */
      }

      /* --- Barra de Informações --- */
      #info-bar {
        background-color: var(--info-bar-bg);
        color: var(--info-bar-text);
        padding: 0 3rem;
        height: 15vh; /* Altura fixa para a barra de info */
        min-height: 80px; /* Altura mínima */
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0; /* Impede que a barra encolha */
      }
      .info-logo {
        font-size: 3vw;
        font-weight: 700;
      }
      #info-clock {
        font-size: 4vw;
        font-weight: 300;
      }

      /* --- Lógica de Layout via Classe no BODY --- */
      body.layout-fullscreen #info-bar {
        display: none; /* Esconde a barra no modo fullscreen */
      }
      body.layout-infobar #info-bar {
        display: flex; /* Garante que a barra apareça */
      }

      /* --- Tela Intersticial (Vinheta) --- */
      #interstitial-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 100;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: url("https://images.pexels.com/photos/1078983/pexels-photo-1078983.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2")
          no-repeat center center/cover;
        color: white;
        transition: opacity 0.5s ease-in-out;
      }
      #interstitial-screen .logo {
        font-size: 6vw;
        font-weight: 700;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
      }
      #clock {
        font-size: 10vw;
        font-weight: 300;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div id="media-container">
      <h1>Iniciando Totem...</h1>
    </div>

    <div id="info-bar">
      <div class="info-logo">ATUAL</div>
      <div id="info-clock"></div>
    </div>

    <div id="interstitial-screen" style="display: none; opacity: 0">
      <div class="logo">imcosta</div>
      <div id="clock"></div>
    </div>

    <script>
      // --- ELEMENTOS DO DOM ---
      const mediaContainer = document.getElementById("media-container");
      const interstitialScreen = document.getElementById("interstitial-screen");
      const clockElement = document.getElementById("clock");
      const infoClockElement = document.getElementById("info-clock");

      // --- CONFIGURAÇÕES ---
      let propagandas = [];
      let propagandaAtualIndex = 0;
      const interstitialIntervalo = 15 * 60;
      const interstitialDuracao = 15 * 1000;
      let tempoAcumulado = 0;

      // --- FUNÇÕES ---
      async function aplicarLayout() {
        try {
          const response = await fetch(
            "https://totem-api-backend.onrender.com/api/settings"
          );
          const settings = await response.json();
          document.body.className = `layout-${settings.layout}`;
        } catch (error) {
          console.error(
            "Falha ao buscar layout, usando padrão infobar.",
            error
          );
          document.body.className = "layout-infobar"; // Fallback
        }
      }

      function startClock() {
        setInterval(() => {
          const now = new Date();
          const formattedTime = now.toLocaleTimeString("pt-BR", {
            hour: "2-digit",
            minute: "2-digit",
          });
          const formattedTimeWithSeconds = now.toLocaleTimeString("pt-BR", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
          if (clockElement) clockElement.textContent = formattedTime;
          if (infoClockElement)
            infoClockElement.textContent = formattedTimeWithSeconds;
        }, 1000);
      }

      async function buscarPropagandas() {
        try {
          const response = await fetch(
            "https://totem-api-backend.onrender.com/api/propagandas"
          ); // CORRETO

          if (!response.ok) throw new Error("Falha ao buscar dados da API.");
          propagandas = await response.json();
          if (propagandas.length === 0) {
            mediaContainer.innerHTML =
              "<h2>Nenhuma propaganda encontrada.</h2>";
            return;
          }
          iniciarCiclo();
        } catch (error) {
          console.error("Erro:", error);
          mediaContainer.innerHTML = `<h2>Erro ao carregar: ${error.message}</h2><p>Tentando novamente em 10 segundos...</p>`;
          setTimeout(buscarPropagandas, 10000);
        }
      }

      function iniciarCiclo() {
        if (propagandas.length === 0) return;

        interstitialScreen.style.opacity = "0";
        setTimeout(() => (interstitialScreen.style.display = "none"), 500);

        const propaganda = propagandas[propagandaAtualIndex];
        mediaContainer.innerHTML = ""; // Limpa o container

        // ##################################################################
        // ## ALTERAÇÃO PRINCIPAL AQUI: Criar dois elementos de mídia      ##
        // ##################################################################

        const tipoElemento = propaganda.type === "image" ? "img" : "video";

        // 1. Cria o elemento de FUNDO (desfocado)
        const backgroundElement = document.createElement(tipoElemento);
        backgroundElement.className = "media-background";
        backgroundElement.src = propaganda.url;

        // 2. Cria o elemento PRINCIPAL (à frente)
        const foregroundElement = document.createElement(tipoElemento);
        foregroundElement.className = "media-foreground";
        foregroundElement.src = propaganda.url;

        // Se for vídeo, adiciona as propriedades de autoplay
        if (tipoElemento === "video") {
          backgroundElement.autoplay = foregroundElement.autoplay = true;
          backgroundElement.muted = foregroundElement.muted = true;
          backgroundElement.loop = foregroundElement.loop = true;
          backgroundElement.playsInline = foregroundElement.playsInline = true;
        }

        // 3. Adiciona ambos ao container
        mediaContainer.appendChild(backgroundElement);
        mediaContainer.appendChild(foregroundElement);
        // ##################################################################

        setTimeout(verificarProximoPasso, propaganda.duration_seconds * 1000);
      }

      function verificarProximoPasso() {
        const propagandaQueAcabou = propagandas[propagandaAtualIndex];
        tempoAcumulado += propagandaQueAcabou.duration_seconds;
        propagandaAtualIndex = (propagandaAtualIndex + 1) % propagandas.length;
        if (tempoAcumulado >= interstitialIntervalo) {
          mostrarInterstitial();
        } else {
          iniciarCiclo();
        }
      }

      function mostrarInterstitial() {
        tempoAcumulado = 0;
        interstitialScreen.style.display = "flex";
        setTimeout(() => (interstitialScreen.style.opacity = "1"), 10);
        setTimeout(iniciarCiclo, interstitialDuracao);
      }

      // --- PONTO DE PARTIDA ---
      async function iniciar() {
        await aplicarLayout();
        startClock();
        buscarPropagandas();
      }

      iniciar();
    </script>
  </body>
</html>
